"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _koaRouter = _interopRequireDefault(require("koa-router"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var getNextId = function getNextId() {
  return Number(_lodash.default.uniqueId());
};

var _default = function _default(router, io) {
  var generalChannelId = getNextId();
  var randomChannelId = getNextId();
  var defaultState = {
    channels: [{
      id: generalChannelId,
      name: 'general',
      removable: false
    }, {
      id: randomChannelId,
      name: 'random',
      removable: false
    }],
    messages: [],
    currentChannelId: generalChannelId
  };

  var state = _objectSpread({}, defaultState);

  var apiRouter = new _koaRouter.default();
  apiRouter.get('/channels', function (ctx) {
    ctx.body = Object.values(state.channels);
    ctx.status = 301;
  }).post('/channels', function (ctx) {
    var name = ctx.request.body.data.attributes.name;
    var channel = {
      name: name,
      removable: true,
      id: getNextId()
    };
    state.channels.push(channel);
    ctx.status = 201;
    var data = {
      data: {
        type: 'channels',
        id: channel.id,
        attributes: channel
      }
    };
    ctx.body = data;
    io.emit('newChannel', data);
  }).delete('/channels/:id', function (ctx) {
    var channelId = Number(ctx.params.id);
    state.channels = state.channels.filter(function (c) {
      return c.id !== channelId;
    });
    state.messages = state.messages.filter(function (m) {
      return m.channelId !== channelId;
    });
    ctx.status = 204;
    var data = {
      data: {
        type: 'channels',
        id: channelId
      }
    };
    io.emit('removeChannel', data);
  }).patch('/channels/:id', function (ctx) {
    var channelId = Number(ctx.params.id);
    var channel = state.channels.find(function (c) {
      return c.id === channelId;
    });
    var attributes = ctx.request.body.data.attributes;
    channel.name = attributes.name;
    ctx.status = 204;
    var data = {
      data: {
        type: 'channels',
        id: channelId,
        attributes: channel
      }
    };
    io.emit('renameChannel', data);
  }).get('/channels/:channelId/messages', function (ctx) {
    var messages = state.messages.filter(function (m) {
      return m.channelId === ctx.params.channelId;
    });
    var resources = messages.map(function (m) {
      return {
        type: 'channels',
        id: m.id,
        attributes: m
      };
    });
    ctx.body = resources;
  }).post('/channels/:channelId/messages', function (ctx) {
    var attributes = ctx.request.body.data.attributes;

    var message = _objectSpread({}, attributes, {
      channelId: Number(ctx.params.channelId),
      id: getNextId()
    });

    state.messages.push(message);
    ctx.status = 201;
    var data = {
      data: {
        type: 'messages',
        id: message.id,
        attributes: message
      }
    };
    ctx.body = data;
    io.emit('newMessage', data);
  });
  return router.get('root', '/', function (ctx) {
    ctx.render('index', {
      gon: state
    });
  }).use('/api/v1', apiRouter.routes(), apiRouter.allowedMethods());
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9yb3V0ZXMuanMiXSwibmFtZXMiOlsiZ2V0TmV4dElkIiwiTnVtYmVyIiwiXyIsInVuaXF1ZUlkIiwicm91dGVyIiwiaW8iLCJnZW5lcmFsQ2hhbm5lbElkIiwicmFuZG9tQ2hhbm5lbElkIiwiZGVmYXVsdFN0YXRlIiwiY2hhbm5lbHMiLCJpZCIsIm5hbWUiLCJyZW1vdmFibGUiLCJtZXNzYWdlcyIsImN1cnJlbnRDaGFubmVsSWQiLCJzdGF0ZSIsImFwaVJvdXRlciIsIlJvdXRlciIsImdldCIsImN0eCIsImJvZHkiLCJPYmplY3QiLCJ2YWx1ZXMiLCJzdGF0dXMiLCJwb3N0IiwicmVxdWVzdCIsImRhdGEiLCJhdHRyaWJ1dGVzIiwiY2hhbm5lbCIsInB1c2giLCJ0eXBlIiwiZW1pdCIsImRlbGV0ZSIsImNoYW5uZWxJZCIsInBhcmFtcyIsImZpbHRlciIsImMiLCJtIiwicGF0Y2giLCJmaW5kIiwicmVzb3VyY2VzIiwibWFwIiwibWVzc2FnZSIsInJlbmRlciIsImdvbiIsInVzZSIsInJvdXRlcyIsImFsbG93ZWRNZXRob2RzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBTUEsU0FBUyxHQUFHLFNBQVpBLFNBQVk7QUFBQSxTQUFNQyxNQUFNLENBQUNDLGdCQUFFQyxRQUFGLEVBQUQsQ0FBWjtBQUFBLENBQWxCOztlQUVlLGtCQUFDQyxNQUFELEVBQVNDLEVBQVQsRUFBZ0I7QUFDN0IsTUFBTUMsZ0JBQWdCLEdBQUdOLFNBQVMsRUFBbEM7QUFDQSxNQUFNTyxlQUFlLEdBQUdQLFNBQVMsRUFBakM7QUFDQSxNQUFNUSxZQUFZLEdBQUc7QUFDbkJDLElBQUFBLFFBQVEsRUFBRSxDQUNSO0FBQUVDLE1BQUFBLEVBQUUsRUFBRUosZ0JBQU47QUFBd0JLLE1BQUFBLElBQUksRUFBRSxTQUE5QjtBQUF5Q0MsTUFBQUEsU0FBUyxFQUFFO0FBQXBELEtBRFEsRUFFUjtBQUFFRixNQUFBQSxFQUFFLEVBQUVI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QVM7QUFBQSxRQUM5QlEsVUFEOEIsR0FDYlIsR0FBRyxDQUFDTSxPQUFKLENBQVlMLElBREMsQ0FDdENNLElBRHNDLENBQzlCQyxVQUQ4Qjs7QUFFOUMsUUFBTWUsT0FBTyxxQkFDUmYsVUFEUTtBQUVYTSxNQUFBQSxTQUFTLEVBQUVoQyxNQUFNLENBQUNrQixHQUFHLENBQUNlLE1BQUosQ0FBV0QsU0FBWixDQUZOO0FBR1h2QixNQUFBQSxFQUFFLEVBQUVWLFNBQVM7QUFIRixNQUFiOztBQUtBZSxJQUFBQSxLQUFLLENBQUNGLFFBQU4sQ0FBZWdCLElBQWYsQ0FBb0JhLE9BQXBCO0FBQ0F2QixJQUFBQSxHQUFHLENBQUNJLE1BQUosR0FBYSxHQUFiO0FBQ0EsUUFBTUcsSUFBSSxHQUFHO0FBQ1hBLE1BQUFBLElBQUksRUFBRTtBQUNKSSxRQUFBQSxJQUFJLEVBQUUsVUFERjtBQUVKcEIsUUFBQUEsRUFBRSxFQUFFZ0MsT0FBTyxDQUFDaEMsRUFGUjtBQUdKaUIsUUFBQUEsVUFBVSxFQUFFZTtBQUhSO0FBREssS0FBYjtBQU9BdkIsSUFBQUEsR0FBRyxDQUFDQyxJQUFKLEdBQVdNLElBQVg7QUFDQXJCLElBQUFBLEVBQUUsQ0FBQzBCLElBQUgsQ0FBUSxZQUFSLEVBQXNCTCxJQUF0QjtBQUNELEdBakZIO0FBbUZBLFNBQU90QixNQUFNLENBQ1ZjLEdBREksQ0FDQSxNQURBLEVBQ1EsR0FEUixFQUNhLFVBQUNDLEdBQUQsRUFBUztBQUN6QkEsSUFBQUEsR0FBRyxDQUFDd0IsTUFBSixDQUFXLE9BQVgsRUFBb0I7QUFBRUMsTUFBQUEsR0FBRyxFQUFFN0I7QUFBUCxLQUFwQjtBQUNELEdBSEksRUFJSjhCLEdBSkksQ0FJQSxTQUpBLEVBSVc3QixTQUFTLENBQUM4QixNQUFWLEVBSlgsRUFJK0I5QixTQUFTLENBQUMrQixjQUFWLEVBSi9CLENBQVA7QUFLRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBSb3V0ZXIgZnJvbSAna29hLXJvdXRlcic7XG5cbmNvbnN0IGdldE5leHRJZCA9ICgpID0+IE51bWJlcihfLnVuaXF1ZUlkKCkpO1xuXG5leHBvcnQgZGVmYXVsdCAocm91dGVyLCBpbykgPT4ge1xuICBjb25zdCBnZW5lcmFsQ2hhbm5lbElkID0gZ2V0TmV4dElkKCk7XG4gIGNvbnN0IHJhbmRvbUNoYW5uZWxJZCA9IGdldE5leHRJZCgpO1xuICBjb25zdCBkZWZhdWx0U3RhdGUgPSB7XG4gICAgY2hhbm5lbHM6IFtcbiAgICAgIHsgaWQ6IGdlbmVyYWxDaGFubmVsSWQsIG5hbWU6ICdnZW5lcmFsJywgcmVtb3ZhYmxlOiBmYWxzZSB9LFxuICAgICAgeyBpZDogcmFuZG9tQ2hhbm5lbElkLCBuYW1lOiAncmFuZG9tJywgcmVtb3ZhYmxlOiBmYWxzZSB9LFxuICAgIF0sXG4gICAgbWVzc2FnZXM6IFtdLFxuICAgIGN1cnJlbnRDaGFubmVsSWQ6IGdlbmVyYWxDaGFubmVsSWQsXG4gIH07XG5cbiAgY29uc3Qgc3RhdGUgPSB7IC4uLmRlZmF1bHRTdGF0ZSB9O1xuXG4gIGNvbnN0IGFwaVJvdXRlciA9IG5ldyBSb3V0ZXIoKTtcbiAgYXBpUm91dGVyXG4gICAgLmdldCgnL2NoYW5uZWxzJywgKGN0eCkgPT4ge1xuICAgICAgY3R4LmJvZHkgPSBPYmplY3QudmFsdWVzKHN0YXRlLmNoYW5uZWxzKTtcbiAgICAgIGN0eC5zdGF0dXMgPSAzMDE7XG4gICAgfSlcbiAgICAucG9zdCgnL2NoYW5uZWxzJywgKGN0eCkgPT4ge1xuICAgICAgY29uc3QgeyBkYXRhOiB7IGF0dHJpYnV0ZXM6IHsgbmFtZSB9IH0gfSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG4gICAgICBjb25zdCBjaGFubmVsID0ge1xuICAgICAgICBuYW1lLFxuICAgICAgICByZW1vdmFibGU6IHRydWUsXG4gICAgICAgIGlkOiBnZXROZXh0SWQoKSxcbiAgICAgIH07XG4gICAgICBzdGF0ZS5jaGFubmVscy5wdXNoKGNoYW5uZWwpO1xuICAgICAgY3R4LnN0YXR1cyA9IDIwMTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiAnY2hhbm5lbHMnLFxuICAgICAgICAgIGlkOiBjaGFubmVsLmlkLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IGNoYW5uZWwsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgY3R4LmJvZHkgPSBkYXRhO1xuXG4gICAgICBpby5lbWl0KCduZXdDaGFubmVsJywgZGF0YSk7XG4gICAgfSlcbiAgICAuZGVsZXRlKCcvY2hhbm5lbHMvOmlkJywgKGN0eCkgPT4ge1xuICAgICAgY29uc3QgY2hhbm5lbElkID0gTnVtYmVyKGN0eC5wYXJhbXMuaWQpO1xuICAgICAgc3RhdGUuY2hhbm5lbHMgPSBzdGF0ZS5jaGFubmVscy5maWx0ZXIoYyA9PiBjLmlkICE9PSBjaGFubmVsSWQpO1xuICAgICAgc3RhdGUubWVzc2FnZXMgPSBzdGF0ZS5tZXNzYWdlcy5maWx0ZXIobSA9PiBtLmNoYW5uZWxJZCAhPT0gY2hhbm5lbElkKTtcbiAgICAgIGN0eC5zdGF0dXMgPSAyMDQ7XG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdHlwZTogJ2NoYW5uZWxzJyxcbiAgICAgICAgICBpZDogY2hhbm5lbElkLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGlvLmVtaXQoJ3JlbW92ZUNoYW5uZWwnLCBkYXRhKTtcbiAgICB9KVxuICAgIC5wYXRjaCgnL2NoYW5uZWxzLzppZCcsIChjdHgpID0+IHtcbiAgICAgIGNvbnN0IGNoYW5uZWxJZCA9IE51bWJlcihjdHgucGFyYW1zLmlkKTtcbiAgICAgIGNvbnN0IGNoYW5uZWwgPSBzdGF0ZS5jaGFubmVscy5maW5kKGMgPT4gYy5pZCA9PT0gY2hhbm5lbElkKTtcblxuICAgICAgY29uc3QgeyBhdHRyaWJ1dGVzIH0gPSBjdHgucmVxdWVzdC5ib2R5LmRhdGE7XG4gICAgICBjaGFubmVsLm5hbWUgPSBhdHRyaWJ1dGVzLm5hbWU7XG4gICAgICBjdHguc3RhdHVzID0gMjA0O1xuICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHR5cGU6ICdjaGFubmVscycsXG4gICAgICAgICAgaWQ6IGNoYW5uZWxJZCxcbiAgICAgICAgICBhdHRyaWJ1dGVzOiBjaGFubmVsLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGlvLmVtaXQoJ3JlbmFtZUNoYW5uZWwnLCBkYXRhKTtcbiAgICB9KVxuICAgIC5nZXQoJy9jaGFubmVscy86Y2hhbm5lbElkL21lc3NhZ2VzJywgKGN0eCkgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZXMgPSBzdGF0ZS5tZXNzYWdlcy5maWx0ZXIobSA9PiBtLmNoYW5uZWxJZCA9PT0gY3R4LnBhcmFtcy5jaGFubmVsSWQpO1xuICAgICAgY29uc3QgcmVzb3VyY2VzID0gbWVzc2FnZXMubWFwKG0gPT4gKHtcbiAgICAgICAgdHlwZTogJ2NoYW5uZWxzJyxcbiAgICAgICAgaWQ6IG0uaWQsXG4gICAgICAgIGF0dHJpYnV0ZXM6IG0sXG4gICAgICB9KSk7XG4gICAgICBjdHguYm9keSA9IHJlc291cmNlcztcbiAgICB9KVxuICAgIC5wb3N0KCcvY2hhbm5lbHMvOmNoYW5uZWxJZC9tZXNzYWdlcycsIChjdHgpID0+IHtcbiAgICAgIGNvbnN0IHsgZGF0YTogeyBhdHRyaWJ1dGVzIH0gfSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG4gICAgICBjb25zdCBtZXNzYWdlID0ge1xuICAgICAgICAuLi5hdHRyaWJ1dGVzLFxuICAgICAgICBjaGFubmVsSWQ6IE51bWJlcihjdHgucGFyYW1zLmNoYW5uZWxJZCksXG4gICAgICAgIGlkOiBnZXROZXh0SWQoKSxcbiAgICAgIH07XG4gICAgICBzdGF0ZS5tZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgY3R4LnN0YXR1cyA9IDIwMTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiAnbWVzc2FnZXMnLFxuICAgICAgICAgIGlkOiBtZXNzYWdlLmlkLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IG1lc3NhZ2UsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgY3R4LmJvZHkgPSBkYXRhO1xuICAgICAgaW8uZW1pdCgnbmV3TWVzc2FnZScsIGRhdGEpO1xuICAgIH0pO1xuXG4gIHJldHVybiByb3V0ZXJcbiAgICAuZ2V0KCdyb290JywgJy8nLCAoY3R4KSA9PiB7XG4gICAgICBjdHgucmVuZGVyKCdpbmRleCcsIHsgZ29uOiBzdGF0ZSB9KTtcbiAgICB9KVxuICAgIC51c2UoJy9hcGkvdjEnLCBhcGlSb3V0ZXIucm91dGVzKCksIGFwaVJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcbn07XG4iXX0=